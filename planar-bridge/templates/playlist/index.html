<!DOCTYPE html>
<html lang="en">
{% let head_scripts = ["/assets/json-enc.2.0.1.js"] %}
{% let head_title = "m web" %}
{% let head_stylesheet = "/assets/playlist.css" %}
{% include "../head.html" %}
<body>
  <!-- Playlist container -->
  <div id="playlist"
       hx-get="/playlist/playlist"
       hx-trigger="load"
       hx-target="#playlist"
       hx-swap="innerHTML">
  </div>

  <!-- Player bar -->
  <div id="player-bar" class="player-bar" style="display:none;">
    <div class="progress-container" onmousedown="startSeek(event)">
      <div id="progress" class="progress"></div>
    </div>
    <div class="controls">
      <button onclick="playPrev()">⏮</button>
      <button id="play-pause" onclick="togglePlay()">⏯</button>
      <button onclick="playNext()">⏭</button>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="1" style="width:100px;">
    </div>
    <div id="song-title" class="song-title">
    </div>
    <div id="song-artist" class="song-artist">
    </div>
    <div id="song-categories" class="song-categories">
    </div>
  </div>

  <audio id="audio" preload="metadata"></audio>

  <script>
    let playlist = [];
    let currentIndex = -1;
    const audio = document.getElementById('audio');
    const playerBar = document.getElementById('player-bar');
    const playPauseBtn = document.getElementById('play-pause');
    const progress = document.getElementById('progress');
    const volumeSlider = document.getElementById('volume');
    let seeking = false;

    function initPlaylist(ids) {
      currentIndex = -1;
      playlist = ids;
    }

    function playSong(index) {
      currentIndex = index;
      const song = playlist[currentIndex];
      audio.src = `/playlist/audio/${song.id}`;
      audio.play();
      playerBar.style.display = 'flex';
      playPauseBtn.textContent = '⏸';
      document.getElementById('song-title').textContent = song.title || '';
      document.getElementById('song-artist').textContent = song.artist || '';
      document.getElementById('song-categories').textContent = song.categories.join(" | ");
    }

    function playNext() {
      if (currentIndex < playlist.length - 1) {
        playSong(currentIndex + 1);
      } else {
        playSong(0);
      }
    }

    function playPrev() {
      if (currentIndex > 0) {
        playSong(currentIndex - 1);
      } else {
        playSong(playlist.length - 1);
      }
    }

    function togglePlay() {
      if (audio.paused) { audio.play(); playPauseBtn.textContent = '⏸'; }
      else { audio.pause(); playPauseBtn.textContent = '▶'; }
    }

    function startSeek(e) {
      seeking = true;
      seekTo(e);
      document.addEventListener('mousemove', seekTo);
      document.addEventListener('mouseup', stopSeek);
    }

    function seekTo(e) {
      const container = document.querySelector('.progress-container');
      const rect = container.getBoundingClientRect();
      const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width)); // clamp
      const ratio = x / rect.width;
      audio.currentTime = ratio * audio.duration;
    }

    function stopSeek() {
      seeking = false;
      document.removeEventListener('mousemove', seekTo);
      document.removeEventListener('mouseup', stopSeek);
    }

    audio.ontimeupdate = () => {
      if (audio.duration) {
        progress.style.width = `${(audio.currentTime / audio.duration) * 100}%`;
      }
    };

    volumeSlider.oninput = () => {
      audio.volume = volumeSlider.value;
    };

    audio.onended = playNext;
  </script>
</body>
</html>
